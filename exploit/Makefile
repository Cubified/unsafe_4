all: exploit

CC=$(DEVKITPPC)/bin/powerpc-eabi-gcc
OBJDUMP=$(DEVKITPPC)/bin/powerpc-eabi-objdump

TOOLSDIR=tools
LOADERDIR=loader
BOOTSTRAPDIR=bootstrap
GCIDIR=$(HOME)/.local/share/dolphin-emu/GC/EUR/Card A

HEADFILE=head.bin
TAILFILE=tail.bin

LOADERELF=$(LOADERDIR)/loader.elf
BOOTSTRAPELF=$(BOOTSTRAPDIR)/bootstrap.elf

DOLFILE="sd:/app.dol\0\0"
ACCESSMODE="rb\0"

LOADER_OPCODES=$(BOOTSTRAPDIR)/data/ascii_opcodes
BOOTSTRAP_OPCODES=$(BOOTSTRAPDIR)/data/bootstrap_opcodes

OUTPUT=exploit.gci

TRUNC=/bin/truncate
MKDIR=/bin/mkdir
ECHO=/bin/echo
CAT=/bin/cat
CP=/bin/cp
DD=/bin/dd
RM=/bin/rm

exploit:
	$(CP) $(HEADFILE) $(OUTPUT)
	$(ECHO) -ne $(DOLFILE) >> $(OUTPUT)
	$(ECHO) -ne $(ACCESSMODE) >> $(OUTPUT)

	$(MAKE) -C $(LOADERDIR)
	$(SH) $(TOOLSDIR)/strip_opcodes.sh $(OBJDUMP) $(LOADERELF) $(TOOLSDIR) $(LOADER_OPCODES)

	$(MKDIR) -p $(BOOTSTAPDIR)/data
	$(BOOTSTRAPDIR)/gen_bootstrap.py $(LOADER_OPCODES)
	$(MAKE) -C $(BOOTSTRAPDIR)
	$(SH) $(TOOLSDIR)/strip_opcodes.sh $(OBJDUMP) $(BOOTSTRAPELF) $(TOOLSDIR) $(BOOTSTRAP_OPCODES)
	$(CAT) $(BOOTSTRAP_OPCODES) | $(SH) $(TOOLSDIR)/to_bytes.py $(OUTPUT)

	$(TRUNC) -s 4260 $(OUTPUT)
	$(DD) if=$(TAILFILE) >> $(OUTPUT)
	$(TRUNC) -s 8256 $(OUTPUT)

clean:
	$(MAKE) -C $(LOADERDIR) clean
	$(MAKE) -C $(BOOTSTRAPDIR) clean
	if [ -e $(OUTPUT) ]; then $(RM) $(OUTPUT); fi

install:
	$(CP) $(OUTPUT) "$(GCIDIR)/00-UNSF-unsafe_savefile.dat.gci"
