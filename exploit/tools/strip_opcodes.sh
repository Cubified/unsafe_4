#!/bin/sh

# strip_opcodes.sh: extracts raw opcodes from a given elf file,
#   writing them as ASCII to a given file

OBJDUMP=$1
ELF=$2
TOOLSDIR=$3
OUTPUT=$4

if [ "$OBJDUMP" = "" -o "$ELF" = "" -o "$TOOLSDIR" = "" -o "$OUTPUT" = "" ]; then
  printf "Usage: strip_opcodes.sh [objdump bin] [elf file] [tools dir] [output file]\n"
  exit
fi

$OBJDUMP -d $ELF |                          # Dump opcodes
  awk -F"\n" -v RS="\n\n" '$1 ~ /_start/' | # View opcodes for _start only
  awk 'NF>4' |                              # Remove any remaining function names (e.g. prologue)
  awk '{print $2 $3 $4 $5}' |               # Condense output
  sed -e ':a;N;$!ba;s/\n//g' > $OUTPUT      # Remove newlines, write to file
