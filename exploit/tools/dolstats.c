/*
 * dolstats.c: prints the contents of a DOL file's 0x100-byte header
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <byteswap.h>

typedef struct _dolheader {
  unsigned int text_pos[7];
  unsigned int data_pos[11];
  unsigned int text_start[7];
  unsigned int data_start[11];
  unsigned int text_size[7];
  unsigned int data_size[11];
  unsigned int bss_start;
  unsigned int bss_size;
  unsigned int entry_point;
  char padding[28];
} dolheader;

int main(int argc, char **argv){
  if(argc < 2){
    printf("Usage: dolstats [file.dol]\n");
    return 1;
  }

  int size;
  FILE *fp = fopen(argv[1], "rb");
  dolheader dol;

  fseek(fp, 0, SEEK_END);
  size = ftell(fp);
  fseek(fp, 0, SEEK_SET);

  char *buf = malloc(size);
  fread(buf, 1, size, fp);

  memcpy(&dol, buf, sizeof(dolheader));

  printf("DOL File \"%s\":\n", argv[1]);
  printf("  Text Offsets (copy from):\n");
  for(int i=0;i<7;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.text_pos[i]));
  }
  printf("  Data Offsets (copy from):\n");
  for(int i=0;i<11;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.data_pos[i]));
  }
  printf("  Text Addresses (copy to):\n");
  for(int i=0;i<7;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.text_start[i]));
  }
  printf("  Data Addresses (copy to):\n");
  for(int i=0;i<11;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.data_start[i]));
  }
  printf("  Text Size:\n");
  for(int i=0;i<7;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.text_size[i]));
  }
  printf("  Data Size:\n");
  for(int i=0;i<11;i++){
    printf("    %i: %#10x\n", i, __bswap_32(dol.data_size[i]));
  }
  printf("  BSS Start:\n");
  printf("    %#10x\n", __bswap_32(dol.bss_start));
  printf("  BSS Size:\n");
  printf("    %#10x\n", __bswap_32(dol.bss_size));
  printf("  Entry Point:\n");
  printf("    %#10x\n", __bswap_32(dol.entry_point));

  free(buf);
  fclose(fp);

  return 0;
}
