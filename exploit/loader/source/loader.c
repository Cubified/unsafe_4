/*
 * loader.c: small DOL loader
 *
 * Performs all relocations necessary for
 * branching to a DOL file's entry point
 *
 * /Heavily/ inspired by FIX94's and
 * ToadKing's loaders
 *
 * 7/1/20, 8:27 pm: Everything is so
 * close to working perfectly, but it
 * just isn't. If I return to this in
 * the future, the problem to solve is
 * that DOL files larger than 256kb(?)
 * crash, and some DOL files just do
 * not load -- I believe the first
 * problem to be caused by the Gekko
 * having 256kb of L2 cache, meaning
 * I would have to find some way of
 * swapping data in/out of the cache
 * in order to load it (that's a guess),
 * whereas the second I have no idea.
 * I'm fairly bummed I haven't completed
 * this project, I've learned a great
 * amount about PowerPC, PPC assembly,
 * stack overflows, using a debugger
 * effectively, using Python to my
 * advantage, etc. -- we'll see what
 * happens with this in the future,
 * however, maybe I'll have a stroke
 * of genius and solve these problems.
 * (But probably not).
 */

#include <stdio.h>
#include <ogc/disc_io.h>

#define SEEK_SET 0
#define SEEK_END 2

#define DOLFILE_STRING 0x92c80
#define ACCESSMODE_STRING 0x92c8d
#define SD_STRING 0x43920
#define WII_IO_POINTER 0x800441cc

typedef struct _dolheader {
  unsigned int text_pos[7];
  unsigned int data_pos[11];
  unsigned int text_start[7];
  unsigned int data_start[11];
  unsigned int text_size[7];
  unsigned int data_size[11];
  unsigned int bss_start;
  unsigned int bss_size;
  unsigned int entry_point;
} dolheader;

FILE *(*_fopen)(char *str, char *mode);
int   (*_fseek)(FILE *fp, long int off, int orig);
int   (*_ftell)(FILE *fp);
char  (*_fgetc)(FILE *fp);
void *(*_malloc)(int size);
void  (*_fatInitDefault)();
int   (*_fatMountSimple)(char *name, void *interface);

/* ToadKing's loader makes use of these, TODO investigate
void  (*_SYS_ResetSystem)(int a, int b, int c);
void  (*__lwp_thread_stopmultitasking)(void *func);
*/

void _start(){
  FILE *fp;
  int size;
  int ind = 0;

  char *ptr, *src;
  int dec;

  unsigned char *dolbuf;
  dolheader *dolfile;

  /***/

  _fopen = (void*)0x8002f0d4;
  _fseek = (void*)0x8002f574;
  _ftell = (void*)0x8002fbd8;
  _fgetc = (void*)0x8002e9f4;

  _malloc            = (void*)0x80030878;
  _fatInitDefault    = (void*)0x80005f5c;
  _fatMountSimple    = (void*)0x80005db4;

  /*
  _SYS_ResetSystem = (void*)0x8000fc9c;
  __lwp_thread_stopmultitasking = (void*)0x800223d4;
  */

  /***/

  _fatInitDefault();
  /*                     "sd"                        &__io_wiisd   */
  _fatMountSimple((char*)SD_STRING, (DISC_INTERFACE*)WII_IO_POINTER);

  /*                 "sd:/app.dol"          "rb"             */
  fp = _fopen((char*)DOLFILE_STRING, (char*)ACCESSMODE_STRING);

  _fseek(fp, 0, SEEK_END);
  size = _ftell(fp);
  _fseek(fp, 0, SEEK_SET);

  dolbuf = _malloc(size);
  dolfile = (dolheader*)dolbuf;

  for(ind=0;ind<size;ind++){
    dolbuf[ind] = _fgetc(fp);
  }

  /* Relocate text (executable code) sections */
  for(ind=0;ind<7;ind++){
    if(dolfile->text_start[ind] > 0x100 &&
       dolfile->text_size[ind]
    ){
      ptr = (char*)dolfile->text_start[ind];
      src = (char*)(dolbuf+dolfile->text_pos[ind]);
      dec = dolfile->text_size[ind];
      while(dec--){
        *ptr++ = *src++;
      }
    }
  }

  /* Relocate data sections */
  for(ind=0;ind<11;ind++){
    if(dolfile->data_start[ind] > 0x100 &&
       dolfile->data_size[ind]
    ){
      ptr = (char*)dolfile->data_start[ind];
      src = (char*)(dolbuf+dolfile->data_pos[ind]);
      dec = dolfile->data_size[ind];
      while(dec--){
        *ptr++ = *src++;
      }
    }
  }

  /* Zero bss */
  ptr = (char*)dolfile->bss_start;
  dec = dolfile->bss_size;
  while(dec--){
    *ptr++ = 0;
  }

  /* Taken from FIX94's loader */
  __asm__ volatile(
    "mtlr %0\n"
    "blr\n"
    :
    : "r"(dolfile->entry_point)
  );
  __builtin_unreachable();
}
